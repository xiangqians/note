<!--
 | @author xiangqian
 | @date 11:49 2023/02/12
 |-->
<!DOCTYPE html>
<html lang="en" url="{{ .url }}">
<head>
    <meta charset="UTF-8">
    <link rel="shortcut icon" rel="external nofollow" href="/static/favicon.ico">
    <link rel="stylesheet" href="/static/custom/custom.css" type="text/css"/>
    <title>{{ Localize "i18n.img" }}</title>
</head>
<body>

{{ template "common/header.html" . }}

<content>
    <!-- response message -->
    <p style="color: red;">{{ .resp.Msg }}</p>

    <!-- response data -->
    <!-- 变量赋值 -->
    {{ $page := .resp.Data }}
    {{ $imgs := $page.Data }}

    <p>
        <span>
            ID: <input type="text" size="5" oninput="this.value = this.value.replace(/^(0+)|[^0-9]+/g, '');">&nbsp;&nbsp;
            {{ Localize "i18n.name" }}: <input search="name" type="text" size="15" value="">&nbsp;&nbsp;
            {{ Localize "i18n.deleted" }}: <input search="deleted" type="checkbox"/>&nbsp;&nbsp;
            <button search="search">{{ Localize "i18n.search" }}</button>&nbsp;
            <a href="/img/list?t={{ Timestamp }}"><button>{{ Localize "i18n.reset" }}</button></a>
        </span>
    </p>

    <table border="1" cellspacing="0" cellpadding="10" align="center">
        <thead>
        <tr>
            <td>{{ Localize "i18n.no." }}</td>
            <td>{{ Localize "i18n.name" }}</td>
            <td>{{ Localize "i18n.type" }}</td>
            <td>{{ Localize "i18n.size" }}</td>
            <td>{{ Localize "i18n.addTime" }}</td>
            <td>{{ Localize "i18n.updTime" }}</td>
            <td colspan="3">{{ Localize "i18n.op" }}</td>
        </tr>
        </thead>
        <tbody>
        {{ $len := len $imgs }}
        {{ if gt $len 0 }}
        {{ range $index,$img := $imgs }}
        <tr img-id="{{ $img.Id }}"
            img-name="{{ $img.Name }}"
            img-type="{{ $img.Type }}">
            <td>{{ No_ $page $index }}</td>
            <td><a href="/img/{{ $img.Id }}/view?t={{ Timestamp }}" target="_blank">{{ $img.Name }}</a></td>
            <td>{{ $img.Type }}</td>
            <td>{{ HumanizFileSize $img.Size }}</td>
            <td>{{ HumanizUnix $img.AddTime }}</td>
            <td>{{ HumanizUnix $img.UpdTime }}</td>
            <td>
                <button copy>{{ Localize "i18n.copy" }} URL</button>
            </td>
            <td>
                <button rename>{{ Localize "i18n.rename" }}</button>
            </td>
            <td>
                <button del>{{ Localize "i18n.del" }}</button>
            </td>
        </tr>
        {{ end }}
        {{ else }}
        <tr>
            <td colspan="9">{{ Localize "i18n.noData" }}</td>
        </tr>
        {{ end }}
        </tbody>
        <tfoot>
        <tr>
            <td colspan="9">
                <span style="margin-right: 10px">{{ Localize "i18n.page.current" }}: {{ $page.Current }}</span>
                <span style="margin-right: 10px">{{ Localize "i18n.page.size" }}: {{ $page.Size }}</span>
                <span style="margin-right: 10px">{{ Localize "i18n.pages" }}: {{ $page.Pages }}</span>
                <span style="margin-right: 20px">{{ Localize "i18n.total" }}: {{ $page.Total }}</span>
                <span style="margin-right: 10px">
                    {{ if le $page.Current 1 }}
                    {{ Localize "i18n.prevPage" }}
                    {{ else }}
                    <a href="/img/list?current={{ Add $page.Current -1 }}&t={{ Timestamp }}">{{ Localize "i18n.prevPage" }}</a>
                    {{  end }}
                </span>
                <span>
                    {{ if ge $page.Current $page.Pages }}
                    {{ Localize "i18n.nextPage" }}
                    {{ else }}
                    <a href="/img/list?current={{ Add $page.Current 1 }}&t={{ Timestamp }}">{{ Localize "i18n.nextPage" }}</a>
                    {{  end }}
                </span>
            </td>
        </tr>
        </tfoot>
    </table>
    <br>
    <br>
    <br>

    <div>
        <form action="/img/upload?t={{ Timestamp }}" method="POST" enctype="multipart/form-data">
            <input name="file" type="file"/>
            <button type="submit">{{ Localize "i18n.upload" }}</button>
        </form>
    </div>

</content>

{{ template "common/footer.html" . }}

</body>
</html>
<script type="text/javascript" src="/static/jquery/jquery.js"></script>
<script type="text/javascript" src="/static/clipboard.js/clipboard.js"></script>
<script type="text/javascript" src="/static/custom/custom.js"></script>
<script type="text/javascript">

    ;(function () {

        function getImg($e) {
            let $tr = $($e.parents("tr:first")[0])
            let id = $tr.attr("img-id")
            let name = $tr.attr("img-name")
            let type = $tr.attr("img-type")

            return {
                id: id,
                name: name,
                type: type,
            }
        }

        // copy
        ;(function () {
            // 销毁 clipboard, 如果存在的话
            if (window.clipboard) {
                window.clipboard.destroy()
                window.clipboard = null
            }

            // clipboard
            let clipboard = new ClipboardJS('[copy]', {
                text: function (e) {
                    let $e = $(e)
                    let img = getImg($e)
                    // console.log(img)
                    return `![${img.name}](/img/${img.id})`
                },
            });

            // on success
            clipboard.on('success', function (e) {
                // console.info('Action:', e.action)
                // console.info('Text:', e.text)
                // console.info('Trigger:', e.trigger)
                alert('{{ Localize "i18n.copied" }}')
            });

            // on error
            clipboard.on('error', function (e) {
                // console.info('Action:', e.action)
                // console.info('Text:', e.text)
                // console.info('Trigger:', e.trigger)
                alert(e)
            });

            window.clipboard = clipboard
        })()

        // rename
        ;(function () {
            let renames = $('[rename]')
            for (let i = 0; i < renames.length; i++) {
                let $rename = $(renames[i])
                custom.clickE($rename, function ($e) {
                    let img = getImg($e)
                    let name = prompt('{{ Localize "i18n.name" }}', img.name)
                    if (!name || (name = name.trim()) === '') {
                        return
                    }

                    let data = new FormData();
                    data.append('id', img.id)
                    data.append('name', name)
                    return {
                        url: '/img/name',
                        method: 'PUT',
                        data: data
                    }
                })
            }
        })()

        // del
        ;(function () {
            let dels = $('[del]')
            for (let i = 0; i < dels.length; i++) {
                let $del = $(dels[i])
                custom.clickE($del, function ($e) {
                    let img = getImg($e)
                    if (!confirm('{{ Localize "i18n.del" }} "' + img.name + '" ?')) {
                        return
                    }

                    return {
                        url: `/img/${img.id}`,
                        method: 'DELETE',
                    }
                })
            }
        })()

    })()

</script>